--TRUNCATE ENGINE_API_BUILDWORKS;
INSERT INTO ENGINE_API_BUILDWORKS
	WITH A AS (
		SELECT 
			WORK_ID,
			SUM(RATINGS_COUNT) AS TOTAL_RATINGS_COUNT,
			SUM(TEXT_REVIEWS_COUNT) AS TOTAL_TEXT_REVIEWS_COUNT,
			MAX(RATINGS_COUNT) AS RATINGS_COUNT
		FROM ENGINE_API_BOOKS
		GROUP BY WORK_ID
	)
	SELECT 
		BOOK_ID,
		WORK_ID,
		TITLE,
		TITLE_WITHOUT_SERIES,
		CAST(ISBN AS BIGINT) ISBN,
		CAST(ISBN13 AS BIGINT) ISBN13,
		TOTAL_TEXT_REVIEWS_COUNT,
		TOTAL_RATINGS_COUNT,
		AVERAGE_RATING,
		SERIES,
		COUNTRY_CODE,
		LANGUAGE_CODE,
		ASIN,
		KINDLE_ASIN,
		IS_EBOOK,
		DESCRIPTION,
		LINK,
		URL,
		IMAGE_URL,
		NUM_PAGES,
		PUBLICATION_DAY,
		PUBLICATION_MONTH,
		PUBLICATION_YEAR,
		FORMAT,
		PUBLISHER,
		EDITION_INFORMATION,
		SIMILAR_BOOKS
	FROM ENGINE_API_BOOKS
	INNER JOIN A
	USING(WORK_ID, RATINGS_COUNT)
ON CONFLICT DO NOTHING;

SELECT *
FROM ENGINE_API_BOOKS
LIMIT 10;